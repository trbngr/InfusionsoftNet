//----------------------
// <auto-generated>
// </auto-generated>
//----------------------
using System;
using LanguageExt;
using Infusion.Model;

namespace Infusion.Ops
{
    public abstract class InfusionOp<A>
    {
        internal class Return : InfusionOp<A>
        {
            public readonly A Value;
            public Return(A value) => Value = value;
        }
        
        {% for op in Operations %}
        internal class {{ op.Name }} : InfusionOp<A>
        {
            public readonly Func<{{ op.ResponseType | normalize }}, InfusionOp<A>> Next;
            {% for p in op.Parameters -%}
            public readonly {{ p.OptionalTypeName }} {{ p.Name | capitalize }};
            {% endfor -%}
            
            public {{ op.Name }}(Func<{{ op.ResponseType | normalize }}, InfusionOp<A>> next{% if op.HasParameters %}, {% endif %}{% for p in op.Parameters %}{{ p.OptionalTypeName }} {{ p.Name }}{% if forloop.last == false %}, {% endif %}{% endfor %})
            {
                Next = next;
              {% for p in op.Parameters -%}
              {{ p.Name | capitalize }} = {{ p.Name }};
              {% endfor -%}
            }
        }
        {% endfor -%}
    }
    
    public static class InfusionOpExtensions
    {
        public static InfusionOp<B> Map<A, B>(this InfusionOp<A> op, Func<A, B> fn) =>
            op.Bind(a => Dsl.Return(fn(a)));
    
        public static InfusionOp<B> Select<A, B>(this InfusionOp<A> op, Func<A, B> fn) =>
            op.Bind(a => Dsl.Return(fn(a)));
    
        public static InfusionOp<C> SelectMany<A, B, C>(this InfusionOp<A> op, Func<A, InfusionOp<B>> bind, Func<A, B, C> project) =>
            op.Bind(a => bind(a).Select(b => project(a, b)));
            
        static InfusionOp<B> Bind<A, B>(this InfusionOp<A> op, Func<A, InfusionOp<B>> fn) =>
            op is InfusionOp<A>.Return rt ? fn(rt.Value) :
            {% for op in Operations %}op is InfusionOp<A>.{{ op.Name }} {% assign opName = forloop.index %} _{{ opName }} ? new InfusionOp<B>.{{ op.Name }}(x => _{{ opName }}.Next(x).Bind(fn){% if op.Parameters.size > 0 %}, {% endif %}{% for parameter in op.Parameters %}_{{opName}}.{{ parameter.Name | capitalize }}{% if forloop.last == false %}, {% endif %}{% endfor %}){% if forloop.last == true %} as InfusionOp<B> {% endif %} :  
            {% endfor %}throw new NotSupportedException();
    }
}